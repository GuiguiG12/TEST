<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>G12 Labs â€” Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- âš ï¸ STYLE STRICTEMENT IDENTIQUE -->
  <!-- (style inchangÃ©, volontairement omis ici pour lisibilitÃ©) -->
  <!-- ðŸ‘‰ Garde exactement ton <style> actuel -->

</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="logo">
    <img src="fulllogo_transparent_nobuffer.png" alt="G12" onerror="this.style.display='none'" />
    <span>G12 Labs</span>
  </div>
  <div class="header-right">
    <div class="network-badge">Arbitrum</div>
    <appkit-button></appkit-button>
  </div>
</header>

<main class="container">

  <div id="notConnected" class="not-connected">
    <i class="ph ph-wallet"></i>
    <h2>Connect Your Wallet</h2>
    <p>Connect your wallet to view your portfolio and manage investments.</p>
    <appkit-button></appkit-button>
  </div>

  <div id="dashboard" style="display:none;">
    <!-- UI inchangÃ©e -->
  </div>

</main>

<footer class="footer">
  G12 Labs Â· Powered by <a href="https://enzyme.finance" target="_blank">Enzyme Protocol</a> Â· Arbitrum
</footer>

<script type="module">
import { createAppKit } from 'https://esm.sh/@reown/appkit'
import { EthersAdapter } from 'https://esm.sh/@reown/appkit-adapter-ethers'
import { arbitrum } from 'https://esm.sh/@reown/appkit/networks'

/* ============================================================
   CONFIG
============================================================ */

const CONFIG = {
  projectId: '5f9c4ad6a6cadf402f5815fa8f07308c',
  chainId: 42161,
  vaultProxy: '0x591E7194FEe6f5615EA89000318E630EaB92FBe1',
  comptrollerProxy: '0xfDFdEB5D433b46c017ea142590d5b7eD1804f28f',
  usdc: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831',
  rpc: 'https://arb1.arbitrum.io/rpc'
}

/* ============================================================
   ABIs (ENZYME OFFICIEL)
============================================================ */

const ERC20_ABI = [
  'function balanceOf(address) view returns (uint256)',
  'function allowance(address,address) view returns (uint256)',
  'function approve(address,uint256) returns (bool)'
]

const VAULT_ABI = [
  'function balanceOf(address) view returns (uint256)',
  'function totalSupply() view returns (uint256)'
]

const COMPTROLLER_ABI = [
  'function buyShares(uint256,uint256) returns (uint256)',
  'function redeemSharesForSpecificAssets(address,uint256,address[],uint256[])'
]

/* ============================================================
   APPKIT
============================================================ */

const modal = createAppKit({
  adapters: [new EthersAdapter()],
  networks: [arbitrum],
  projectId: CONFIG.projectId,
  metadata: {
    name: 'G12 Labs',
    description: 'DeFi Investment Platform',
    url: 'https://guiguig12.github.io',
    icons: ['https://guiguig12.github.io/TEST/fulllogo_transparent_nobuffer.png']
  },
  features: {
    email: true,
    socials: ['google', 'apple', 'discord'],
    onramp: true,
    swaps: true
  },
  themeMode: 'dark'
})

/* ============================================================
   STATE
============================================================ */

let userAddress = null
let userUsdcBalance = 0
let userSharesBalance = 0

/* ============================================================
   UTILS
============================================================ */

async function ensureArbitrum(provider) {
  const network = await provider.getNetwork()
  if (network.chainId !== CONFIG.chainId) {
    throw new Error('Please switch to Arbitrum One and retry.')
  }
}

function showDashboard(show) {
  document.getElementById('notConnected').style.display = show ? 'none' : 'block'
  document.getElementById('dashboard').style.display = show ? 'block' : 'none'
}

/* ============================================================
   LOAD DATA (RPC SAFE)
============================================================ */

async function loadUserData() {
  if (!userAddress) return

  const rpc = new ethers.providers.JsonRpcProvider(CONFIG.rpc)
  const vault = new ethers.Contract(CONFIG.vaultProxy, VAULT_ABI, rpc)
  const usdc = new ethers.Contract(CONFIG.usdc, ERC20_ABI, rpc)

  const [shares, usdcBal, supply] = await Promise.all([
    vault.balanceOf(userAddress),
    usdc.balanceOf(userAddress),
    vault.totalSupply()
  ])

  userSharesBalance = parseFloat(ethers.utils.formatUnits(shares, 18))
  userUsdcBalance = parseFloat(ethers.utils.formatUnits(usdcBal, 6))

  document.getElementById('userShares').textContent = userSharesBalance.toFixed(4)
  document.getElementById('usdcBalance').textContent = userUsdcBalance.toFixed(2)
  document.getElementById('vaultSupply').textContent = ethers.utils.formatUnits(supply, 18)
}

/* ============================================================
   DEPOSIT â€” ROBUST META MASK
============================================================ */

window.executeDeposit = async function () {
  const amountStr = document.getElementById('depositAmount').value
  if (!amountStr || parseFloat(amountStr) <= 0) return

  const walletProvider = modal.getWalletProvider()
  const provider = new ethers.providers.Web3Provider(walletProvider)
  const signer = provider.getSigner()

  await ensureArbitrum(provider)

  const usdc = new ethers.Contract(CONFIG.usdc, ERC20_ABI, signer)
  const comptroller = new ethers.Contract(CONFIG.comptrollerProxy, COMPTROLLER_ABI, signer)

  const amount = ethers.utils.parseUnits(amountStr, 6)

  const allowance = await usdc.allowance(userAddress, CONFIG.vaultProxy)
  if (allowance.lt(amount)) {
    const tx = await usdc.approve(CONFIG.vaultProxy, ethers.constants.MaxUint256)
    await tx.wait()
  }

  let minShares = 0
  try {
    const expected = await comptroller.callStatic.buyShares(amount, 0)
    minShares = expected.mul(9750).div(10000)
  } catch {
    minShares = 0
  }

  const tx = await comptroller.buyShares(amount, minShares, { gasLimit: 600000 })
  await tx.wait()

  await loadUserData()
}

/* ============================================================
   REDEEM â€” ROBUST
============================================================ */

window.executeRedeem = async function () {
  const amountStr = document.getElementById('redeemAmount').value
  if (!amountStr || parseFloat(amountStr) <= 0) return

  const walletProvider = modal.getWalletProvider()
  const provider = new ethers.providers.Web3Provider(walletProvider)
  const signer = provider.getSigner()

  await ensureArbitrum(provider)

  const comptroller = new ethers.Contract(CONFIG.comptrollerProxy, COMPTROLLER_ABI, signer)
  const shares = ethers.utils.parseUnits(amountStr, 18)

  const tx = await comptroller.redeemSharesForSpecificAssets(
    userAddress,
    shares,
    [CONFIG.usdc],
    [10000],
    { gasLimit: 700000 }
  )

  await tx.wait()
  await loadUserData()
}

/* ============================================================
   ACCOUNT HANDLING
============================================================ */

modal.subscribeAccount(account => {
  if (account.isConnected && account.address) {
    userAddress = account.address
    showDashboard(true)
    loadUserData()
  } else {
    showDashboard(false)
    userAddress = null
  }
})

</script>
</body>
</html>
