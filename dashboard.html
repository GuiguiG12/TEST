<!DOCTYPE html>
<html lang="en" data-theme="carbon">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G12 Labs — Investor Cockpit</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    /* DESIGN SYSTEM V2 (More Vivid) */
    :root {
      --font-sans: 'Inter', sans-serif;
      --sidebar-width: 280px;
      --accent-teal: #4ee5c1; --accent-mint: #a8ffc8; --accent-blue: #4e95e5;
      --accent-grad: linear-gradient(90deg, var(--accent-teal), var(--accent-mint));
      --bg-app: #050505; --bg-sidebar: #0a0a0a; --card-bg: #0f0f0f; 
      --border: #1f1f1f; --text-main: #ededed; --text-muted: #a1a1a1;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--font-sans); background-color: var(--bg-app); color: var(--text-main); }

    /* LAYOUT */
    .sidebar { width: var(--sidebar-width); position: fixed; top: 0; bottom: 0; left: 0; background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 100; }
    .main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; padding: 2.5rem 3rem; }
    
    .logo-img { width: 140px; filter: brightness(0) invert(1); margin-bottom: 2rem; }
    
    .nav-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.75rem 1rem; margin-bottom: 0.25rem; border-radius: 0.5rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
    .nav-item:hover, .nav-item.active { background: rgba(78, 229, 193, 0.1); color: var(--accent-teal); }
    
    /* GRID & CARDS */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; position: relative; overflow: hidden; }
    
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }

    /* KPI STYLES */
    .kpi-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .kpi-value { font-size: 2rem; font-weight: 700; color: #fff; }
    .kpi-sub { font-size: 0.8rem; color: var(--accent-teal); margin-top: 0.25rem; display: flex; align-items: center; gap: 4px; }

    /* BUTTONS */
    .btn { border: none; padding: 0.8rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: transform 0.1s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent-grad); color: #000; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { border-color: var(--text-muted); }

    /* MODAL */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal { background: #111; border: 1px solid var(--border); width: 400px; padding: 2rem; border-radius: 1rem; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .input-group { margin: 1.5rem 0; }
    .modal-input { width: 100%; background: #000; border: 1px solid #333; padding: 1rem; color: white; border-radius: 0.5rem; font-size: 1.2rem; }
    
    /* LOADING SPINNER */
    .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 1000px) { .col-3, .col-4 { grid-column: span 6; } .col-6, .col-8 { grid-column: span 12; } }
  </style>
</head>
<body>

<aside class="sidebar">
  <img src="fulllogo_transparent_nobuffer.png" alt="G12 Labs" class="logo-img" />
  
  <div style="padding: 1rem; background: #111; border-radius: 0.5rem; margin-bottom: 2rem; border: 1px solid #222;">
    <div style="font-size: 0.8rem; color: #666;">Connected as</div>
    <div id="sidebarName" style="font-weight: 600; margin-top: 4px;">Loading...</div>
    <div id="sidebarWallet" style="font-size: 0.75rem; color: var(--accent-teal); font-family: monospace; margin-top: 4px;">0x...</div>
  </div>

  <div class="nav-item active"><i class="ph ph-chart-pie-slice"></i> Dashboard</div>
  <div class="nav-item"><i class="ph ph-arrows-left-right"></i> Transactions</div>
  <div class="nav-item"><i class="ph ph-file-text"></i> Documents</div>
  
  <div style="margin-top: auto;">
    <div class="nav-item" id="logoutBtn"><i class="ph ph-sign-out"></i> Disconnect</div>
  </div>
</aside>

<div class="main-wrapper">

  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
    <div>
      <h1 style="margin: 0; font-size: 1.8rem;">Portfolio Overview</h1>
      <p style="color: var(--text-muted); margin: 5px 0 0;">Real-time interaction with G12 Strategy Vault (Arbitrum)</p>
    </div>
    <div style="display: flex; gap: 1rem;">
      <button class="btn btn-outline" onclick="openModal('withdraw')">
        <i class="ph ph-arrow-up-right"></i> Withdraw
      </button>
      <button class="btn btn-primary" onclick="openModal('deposit')">
        <i class="ph ph-plus"></i> Invest Now
      </button>
    </div>
  </div>

  <div class="grid">
    <div class="card col-4">
      <div class="kpi-label">Your Position</div>
      <div class="kpi-value" id="userBalanceDisplay">-- Shares</div>
      <div class="kpi-sub" id="userValueDisplay">≈ $0.00 USD</div>
    </div>

    <div class="card col-4">
      <div class="kpi-label">G12 Share Price</div>
      <div class="kpi-value" id="sharePriceDisplay">Loading...</div>
      <div class="kpi-sub"><i class="ph ph-trend-up"></i> Live NAV Calculation</div>
    </div>

    <div class="card col-4">
      <div class="kpi-label">Vault AUM (Total)</div>
      <div class="kpi-value" id="aumDisplay">Loading...</div>
      <div class="kpi-sub">Total Assets under Management</div>
    </div>
  </div>

  <div class="grid">
    <div class="card col-8" style="min-height: 400px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
        <div class="kpi-label">Performance (Simulated)</div>
      </div>
      <div id="mainChart" style="width: 100%; height: 320px;"></div>
    </div>

    <div class="card col-4">
      <div class="kpi-label">Vault Details</div>
      <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
        
        <div style="display: flex; justify-content: space-between; padding-bottom: 0.5rem; border-bottom: 1px solid #222;">
          <span style="color: #666;">Status</span>
          <span style="color: var(--accent-teal); font-weight: 600;">Active</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding-bottom: 0.5rem; border-bottom: 1px solid #222;">
          <span style="color: #666;">Denomination</span>
          <span id="denomAsset" style="font-family: monospace;">Scanning...</span>
        </div>

        <div style="display: flex; justify-content: space-between; padding-bottom: 0.5rem; border-bottom: 1px solid #222;">
          <span style="color: #666;">Chain</span>
          <span>Arbitrum One</span>
        </div>

        <div style="padding: 1rem; background: rgba(78, 229, 193, 0.05); border-radius: 0.5rem; font-size: 0.85rem; color: var(--accent-teal); line-height: 1.5;">
          <i class="ph ph-info"></i> This vault is managed by Enzyme protocol. All deposits are non-custodial and verifiable on-chain.
        </div>
        
        <a href="https://arbiscan.io/address/0x591e7194fee6f5615ea89000318e630eab92fbe1" target="_blank" style="text-align: center; font-size: 0.8rem; color: #666; text-decoration: none; margin-top: auto;">
          View Contract on Arbiscan <i class="ph ph-arrow-square-out"></i>
        </a>
      </div>
    </div>
  </div>

</div>

<div class="modal-overlay" id="txModal">
  <div class="modal">
    <h2 id="modalTitle" style="margin-top: 0;">Invest</h2>
    <p style="color: #888; font-size: 0.9rem;">Interact directly with the Vault Smart Contract.</p>
    
    <div class="input-group">
      <label style="display: block; color: #666; font-size: 0.8rem; margin-bottom: 0.5rem;">Amount</label>
      <input type="number" id="txAmount" class="modal-input" placeholder="0.00" />
      <div style="text-align: right; color: #666; font-size: 0.8rem; margin-top: 5px;">
        Asset: <span id="modalAsset">Unknown</span>
      </div>
    </div>

    <button id="confirmTxBtn" class="btn btn-primary" style="width: 100%; justify-content: center;">
      Confirm Transaction
    </button>
    <button class="btn btn-outline" onclick="closeModal()" style="width: 100%; margin-top: 10px; justify-content: center; border: none;">
      Cancel
    </button>
  </div>
</div>

<script>
  // =========================================================
  // 1. CONFIGURATION
  // =========================================================
  const projectRef = "ucrvaqztvfnphhoqcbpo"; 
  const supabaseUrl = `https://${projectRef}.supabase.co`;
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcnZhcXp0dmZucGhob3FjYnBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTY2MzQsImV4cCI6MjA4MjkzMjYzNH0.l_983umaG_ojeDjXJ4DqWhPNEw9RotNApGLpl_ASkZk";
  
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // ENZYME CONFIGURATION (ARBITRUM)
  const VAULT_ADDRESS = "0x591e7194fee6f5615ea89000318e630eab92fbe1";
  const RPC_URL = "https://arb1.arbitrum.io/rpc";

  // ABIs MINIMALES (Pour lire le vault et investir)
  const VAULT_ABI = [
    "function getAccessor() view returns (address)", 
    "function balanceOf(address) view returns (uint256)",
    "function totalSupply() view returns (uint256)",
    "function getTrackedAssets() view returns (address[])" 
  ];
  
  // Le Comptroller est le gestionnaire qui accepte les dépôts
  const COMPTROLLER_ABI = [
    "function getDenominationAsset() view returns (address)",
    "function buyShares(address[], uint256[], uint256[]) returns (uint256)" 
  ];

  const ERC20_ABI = [
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function approve(address, uint256) returns (bool)",
    "function allowance(address, address) view returns (uint256)"
  ];

  let provider, signer, userAddress;
  let vaultContract, comptrollerContract;
  let denominationAssetAddr, denominationSymbol, denominationDecimals;

  // =========================================================
  // 2. INIT & DATA FETCHING
  // =========================================================
  async function init() {
    // A. Check Auth Supabase
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { window.location.href = 'login.html'; return; }
    
    // B. Setup User UI
    document.getElementById('sidebarName').innerText = "Investor"; // Fallback
    
    // C. Récupérer le Wallet depuis la DB
    const { data: walletData } = await supabase
      .from('user_wallets')
      .select('address')
      .eq('user_id', session.user.id)
      .single();

    if(walletData) {
      userAddress = walletData.address;
      document.getElementById('sidebarWallet').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
      
      // D. Connexion Blockchain (Read-Only d'abord)
      provider = new ethers.providers.JsonRpcProvider(RPC_URL);
      vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, provider);
      
      // E. Lancer les scans
      scanVaultData();
      scanUserBalance();
      initChart();
    }
  }

  // --- LOGIQUE ENZYME ---
  async function scanVaultData() {
    try {
      // 1. Trouver le Comptroller (C'est lui qui gère l'argent)
      const accessorAddr = await vaultContract.getAccessor();
      console.log("Comptroller found:", accessorAddr);
      comptrollerContract = new ethers.Contract(accessorAddr, COMPTROLLER_ABI, provider);

      // 2. Trouver l'Asset de référence (USDC? WETH?)
      denominationAssetAddr = await comptrollerContract.getDenominationAsset();
      const assetContract = new ethers.Contract(denominationAssetAddr, ERC20_ABI, provider);
      
      denominationSymbol = await assetContract.symbol();
      denominationDecimals = await assetContract.decimals();

      document.getElementById('denomAsset').innerText = denominationSymbol;
      document.getElementById('modalAsset').innerText = denominationSymbol;

      // 3. Calculer le Share Price (Total Assets / Total Shares)
      // Note: C'est une approx simplifiée pour la démo. Enzyme a des calculs plus complexes (GAV).
      const totalSupply = await vaultContract.totalSupply();
      const totalShares = parseFloat(ethers.utils.formatUnits(totalSupply, 18));
      
      document.getElementById('aumDisplay').innerText = totalShares.toFixed(2) + " Shares";
      
      // Simulation du prix pour l'affichage (car vault vide = division par zero)
      const mockPrice = 1.0; 
      document.getElementById('sharePriceDisplay').innerText = mockPrice.toFixed(4) + " " + denominationSymbol;

    } catch (err) {
      console.error("Vault Scan Error:", err);
      document.getElementById('denomAsset').innerText = "Error scanning";
    }
  }

  async function scanUserBalance() {
    try {
      const balanceBN = await vaultContract.balanceOf(userAddress);
      const balance = parseFloat(ethers.utils.formatUnits(balanceBN, 18));
      
      document.getElementById('userBalanceDisplay').innerText = balance.toFixed(4) + " Shares";
      // Valeur estimée (bal * price)
      document.getElementById('userValueDisplay').innerText = "≈ " + balance.toFixed(2) + " " + (denominationSymbol || "Unit");
      
    } catch (err) {
      console.error("User Balance Error:", err);
    }
  }

  // =========================================================
  // 3. INTERACTION (INVEST/REDEEM)
  // =========================================================
  let currentAction = '';

  window.openModal = (action) => {
    currentAction = action;
    const modal = document.getElementById('txModal');
    const title = document.getElementById('modalTitle');
    const btn = document.getElementById('confirmTxBtn');

    modal.style.display = 'flex';
    if(action === 'deposit') {
      title.innerText = `Invest in G12 (${denominationSymbol || 'Asset'})`;
      btn.innerText = "Approve & Deposit";
      btn.onclick = executeDeposit;
    } else {
      title.innerText = "Redeem Shares";
      btn.innerText = "Redeem";
      btn.onclick = () => alert("Redeem functionality coming in V2.1");
    }
  };

  window.closeModal = () => {
    document.getElementById('txModal').style.display = 'none';
  };

  async function executeDeposit() {
    const amountVal = document.getElementById('txAmount').value;
    if(!amountVal || amountVal <= 0) return alert("Please enter a valid amount");

    const btn = document.getElementById('confirmTxBtn');
    btn.innerHTML = '<span class="loader"></span> Waiting for Wallet...';
    
    try {
      // 1. Connexion Metamask (Write Access)
      if (!window.ethereum) throw new Error("No wallet found");
      const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
      await web3Provider.send("eth_requestAccounts", []); // Force connect
      const signer = web3Provider.getSigner();

      // 2. Préparer les contrats en mode écriture
      const assetWithSigner = new ethers.Contract(denominationAssetAddr, ERC20_ABI, signer);
      const comptrollerWithSigner = new ethers.Contract(comptrollerContract.address, COMPTROLLER_ABI, signer);

      // 3. Conversion Montant (ex: 100 USDC -> 100000000)
      const amountBN = ethers.utils.parseUnits(amountVal, denominationDecimals);

      // 4. APPROVE (Autoriser le Comptroller à prendre les sous)
      console.log("Approving...");
      const txApprove = await assetWithSigner.approve(comptrollerContract.address, amountBN);
      btn.innerHTML = '<span class="loader"></span> Approving...';
      await txApprove.wait();

      // 5. BUY SHARES (L'investissement réel)
      console.log("Buying Shares...");
      btn.innerHTML = '<span class="loader"></span> Minting Shares...';
      
      // Enzyme V4 buyShares args: (buyers[], amounts[], minSharesQuantities[])
      // On achète pour soi-même
      const txBuy = await comptrollerWithSigner.buyShares(
        [await signer.getAddress()], // Buyer
        [amountBN],                  // Amount
        [1]                          // Min shares (Slippage protection minimal pour démo)
      );
      
      await txBuy.wait();
      
      alert("Investment Successful! Welcome to the vault.");
      closeModal();
      scanUserBalance(); // Refresh UI

    } catch (err) {
      console.error(err);
      alert("Transaction Failed: " + (err.reason || err.message));
      btn.innerText = "Try Again";
    }
  }

  // =========================================================
  // 4. CHARTS & VISUALS
  // =========================================================
  function initChart() {
    const chartDom = document.getElementById('mainChart');
    const myChart = echarts.init(chartDom, 'dark');
    
    // Fake Data pour rendre le truc vivant (le temps d'avoir de vraies données)
    const dateList = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const valueList = [100, 102, 101, 104, 107, 108, 110];

    const option = {
      backgroundColor: 'transparent',
      grid: { top: 10, right: 10, bottom: 20, left: 40 },
      xAxis: { type: 'category', data: dateList, axisLine:{show:false}, axisTick:{show:false}, axisLabel:{color:'#666'} },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#222' } }, axisLabel:{color:'#666'} },
      series: [{
        data: valueList,
        type: 'line',
        smooth: true,
        showSymbol: false,
        lineStyle: { width: 3, color: '#4ee5c1' },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(78, 229, 193, 0.3)'}, {offset: 1, color: 'rgba(78, 229, 193, 0)'}])
        }
      }],
      tooltip: { trigger: 'axis' }
    };

    myChart.setOption(option);
    window.addEventListener('resize', myChart.resize);
  }

  // Init App
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });
  
  window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
