<!DOCTYPE html>
<html lang="en" data-theme="carbon">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G12 Labs — Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    /* DESIGN SYSTEM */
    :root {
      --font-sans: 'Inter', sans-serif;
      --sidebar-width: 280px;
      --radius-lg: 1rem; --radius-md: 0.75rem; --radius-sm: 0.5rem; --radius-pill: 999px;
      --accent-teal: #4ee5c1; --accent-mint: #a8ffc8;
      --accent-grad: linear-gradient(90deg, var(--accent-teal), var(--accent-mint));
    }

    [data-theme="carbon"] {
      --bg-app: #050505; --bg-sidebar: #0a0a0a; --sidebar-border: #1f1f1f;
      --card-bg: #0f0f0f; --card-border-color: #1f1f1f; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
      --text-main: #ededed; --text-muted: #a1a1a1; --text-soft: #525252;
      --input-bg: #0a0a0a; --input-border: #262626; --btn-glass-bg: #171717;
      --logo-filter: brightness(0) invert(1);
    }

    [data-theme="quartz"] {
      --bg-app: #ffffff; --bg-sidebar: #f9fafb; --sidebar-border: #e5e7eb;
      --card-bg: #ffffff; --card-border-color: #e5e7eb; --card-shadow: 0 2px 4px rgba(0,0,0,0.02);
      --text-main: #0a0a0a; --text-muted: #525252; --text-soft: #a3a3a3;
      --input-bg: #ffffff; --input-border: #e5e7eb; --btn-glass-bg: #f3f4f6;
      --logo-filter: invert(1) brightness(0); 
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--font-sans); background-color: var(--bg-app); color: var(--text-main); visibility: visible; opacity: 1; }

    /* LAYOUT */
    .sidebar { width: var(--sidebar-width); position: fixed; top: 0; bottom: 0; left: 0; background: var(--bg-sidebar); border-right: 1px solid var(--sidebar-border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s; }
    .logo-img { width: 140px; filter: var(--logo-filter); margin-bottom: 2rem; }
    
    .user-card { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: var(--btn-glass-bg); border-radius: var(--radius-md); border: 1px solid var(--sidebar-border); margin-bottom: 2rem; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid var(--sidebar-border); }
    
    .nav-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.75rem 1rem; margin-bottom: 0.25rem; border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
    .nav-item:hover, .nav-item.active { background: rgba(78, 229, 193, 0.1); color: var(--accent-teal); }
    
    .main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; padding: 2.5rem 3rem; }
    .header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2.5rem; }
    
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
    .card { background: var(--card-bg); border: 1px solid var(--card-border-color); border-radius: var(--radius-lg); padding: 1.5rem; }
    
    .kpi-card { grid-column: span 3; }
    .kpi-value { font-size: 2.2rem; font-weight: 800; margin: 0.5rem 0; }
    .chart-half { grid-column: span 6; min-height: 380px; }
    .full-width { grid-column: span 12; }

    /* Mobile */
    @media (max-width: 1000px) { .kpi-card { grid-column: span 6; } .chart-half { grid-column: span 12; } }
    @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main-wrapper { margin-left: 0; padding: 1.5rem; } }
  </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <img src="fulllogo_transparent_nobuffer.png" alt="G12 Labs" class="logo-img" />

  <div class="user-card">
    <div class="avatar" id="sidebarAvatar">..</div>
    <div class="user-info">
      <div id="sidebarName" style="font-weight:600; font-size:0.9rem;">Loading...</div>
      <span id="sidebarID" style="font-size:0.75rem; color:var(--text-soft);">...</span>
    </div>
  </div>

  <div class="nav-item active" onclick="switchView('dashboard')"><i class="ph ph-squares-four"></i> Overview</div>
  <div class="nav-item" onclick="switchView('transactions')"><i class="ph ph-list-dashes"></i> Transactions</div>
  <div class="nav-item" onclick="alert('Settings coming soon')"><i class="ph ph-gear"></i> Settings</div>

  <div class="nav-item" id="logoutBtn" style="margin-top:auto; border-top:1px solid var(--sidebar-border); padding-top:1rem;">
    <i class="ph ph-sign-out"></i> Disconnect
  </div>
</aside>

<div class="main-wrapper">
  
  <div class="header-row">
    <div>
      <h1 id="headerWelcome" style="margin:0; font-size:2rem;">Welcome back</h1>
      <p style="color:var(--text-muted); margin:5px 0 0;">Blockchain Portfolio Overview</p>
    </div>
    <div style="display:flex; gap:10px;">
       <button id="themeToggle" style="background:var(--card-bg); border:1px solid var(--sidebar-border); width:40px; height:40px; border-radius:50%; color:var(--text-muted); cursor:pointer;"><i class="ph ph-sun"></i></button>
    </div>
  </div>

  <div id="view-dashboard" class="grid">
    
    <div class="card kpi-card">
      <div style="color:var(--text-muted); font-size:0.9rem;">Total Shares</div>
      <div class="kpi-value" id="kpiShares">0.00</div>
      <div style="font-size:0.85rem; color:var(--accent-teal);">Active in Vault</div>
    </div>

    <div class="card kpi-card">
      <div style="color:var(--text-muted); font-size:0.9rem;">Est. Value (USDC)</div>
      <div class="kpi-value" id="kpiValue">--</div>
      <div style="font-size:0.85rem; color:var(--text-soft);">Based on Live NAV</div>
    </div>

    <div class="card kpi-card">
      <div style="color:var(--text-muted); font-size:0.9rem;">Net Yield</div>
      <div class="kpi-value">--</div>
      <div style="font-size:0.85rem; color:var(--text-soft);">Calculated Monthly</div>
    </div>

    <div class="card kpi-card">
       <div style="color:var(--text-muted); font-size:0.9rem;">Wallet Status</div>
       <div class="kpi-value" style="font-size:1.5rem; margin-top:1rem; color:var(--accent-teal);">Connected</div>
       <div id="kpiWalletAddr" style="font-size:0.8rem; font-family:monospace; opacity:0.7;">0x...</div>
    </div>

    <div class="card full-width">
      <h3 style="margin-top:0;">Your Vault Allocations</h3>
      <div id="allocList" style="display:flex; flex-direction:column; gap:1rem;">
         <div style="padding:2rem; text-align:center; color:var(--text-soft);">Scanning blockchain...</div>
      </div>
    </div>

  </div>

</div>

<script>
  // =========================================================
  // 1. CONFIGURATION (NOUVEAU PROJET)
  // =========================================================
  // Ton ID de projet correct (celui où tu as déployé la fonction)
  const projectRef = "ucrvaqztvfnphhoqcbpo"; 
  const supabaseUrl = `https://${projectRef}.supabase.co`;
  
  // TA NOUVELLE CLÉ ANON (Celle que tu m'as donnée)
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcnZhcXp0dmZucGhob3FjYnBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTY2MzQsImV4cCI6MjA4MjkzMjYzNH0.l_983umaG_ojeDjXJ4DqWhPNEw9RotNApGLpl_ASkZk";

  // Config Etherscan / Blockchain
  const CONFIG = {
    apiKey: "E12EJ9IVTKNG1I6RP2189942FN8E3R3V9P", // Ta clé Etherscan
    chains: [
      {
        id: "arbitrum", chainId: 42161, name: "Arbitrum One",
        vaultAddress: "0x591e7194fee6f5615ea89000318e630eab92fbe1", // Ton Vault Test
        rpcUrl: "https://arb1.arbitrum.io/rpc"
      }
    ]
  };

  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // =========================================================
  // 2. INITIALISATION & SÉCURITÉ
  // =========================================================
  async function initDashboard() {
    // A. Vérifier la session
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      console.log("No active session. Redirecting to login...");
      window.location.href = 'login.html';
      return;
    }

    const userId = session.user.id;
    console.log("User Logged In:", userId);

    // B. Récupérer le Profil (Table: profiles)
    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (profile) {
      document.getElementById('sidebarName').innerText = profile.full_name || "Investor";
      document.getElementById('sidebarID').innerText = profile.investor_id || "ID Pending";
      document.getElementById('headerWelcome').innerText = `Welcome, ${profile.investor_id}`;
      document.getElementById('sidebarAvatar').innerText = (profile.investor_id || "G12").substring(4,6);
    }

    // C. Récupérer le Wallet lié (Table: user_wallets)
    const { data: walletData } = await supabase
      .from('user_wallets')
      .select('address')
      .eq('user_id', userId)
      .single();

    if (walletData && walletData.address) {
       const userWallet = walletData.address;
       document.getElementById('kpiWalletAddr').innerText = userWallet.substring(0,6) + "..." + userWallet.substring(38);
       
       // D. Lancer le scan Blockchain avec la vraie adresse
       scanVaults(userWallet);
    } else {
       document.getElementById('allocList').innerHTML = "No wallet linked to this account.";
    }
  }

  // =========================================================
  // 3. SCAN BLOCKCHAIN (Lecture Seule)
  // =========================================================
  async function scanVaults(userWallet) {
    const allocList = document.getElementById('allocList');
    allocList.innerHTML = ''; // Clear loading
    let totalShares = 0;

    for (const chain of CONFIG.chains) {
        try {
            // Lecture RPC Directe
            const provider = new ethers.providers.JsonRpcProvider(chain.rpcUrl);
            const vaultContract = new ethers.Contract(
                chain.vaultAddress, 
                ["function balanceOf(address) view returns (uint256)"], 
                provider
            );
            
            const balanceBN = await vaultContract.balanceOf(userWallet);
            const balance = parseFloat(ethers.utils.formatUnits(balanceBN, 18)); 

            if (balance > 0) {
                totalShares += balance;
                addAllocRow(chain.name, balance, "Active");
            } else {
                // Si pas d'investissement, on peut le logger ou ne rien afficher
                console.log("No balance on", chain.name);
            }
        } catch (err) {
            console.error("Error scanning chain:", chain.name, err);
        }
    }

    // Mise à jour UI
    document.getElementById('kpiShares').innerText = totalShares.toFixed(4);
    if(totalShares === 0) {
        allocList.innerHTML = `<div style="padding:1rem; color:var(--text-soft); text-align:center;">No active positions found in G12 Vaults for wallet ${userWallet.substring(0,6)}...</div>`;
    }
  }

  function addAllocRow(name, amount, status) {
      const html = `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:1rem; background:rgba(255,255,255,0.03); border:1px solid var(--sidebar-border); border-radius:0.5rem;">
          <div style="display:flex; align-items:center; gap:1rem;">
             <div style="width:40px; height:40px; background:rgba(78,229,193,0.1); color:var(--accent-teal); display:flex; align-items:center; justify-content:center; border-radius:8px; font-weight:bold;">V</div>
             <div>
                <div style="font-weight:600;">G12 Strategy</div>
                <div style="font-size:0.8rem; color:var(--text-soft);">${name}</div>
             </div>
          </div>
          <div style="text-align:right;">
             <div style="font-weight:700; font-size:1.1rem;">${amount.toFixed(4)} Shares</div>
             <div style="font-size:0.8rem; color:var(--accent-teal);">${status}</div>
          </div>
      </div>`;
      document.getElementById('allocList').innerHTML += html;
  }

  // =========================================================
  // 4. EVENTS & UTILS
  // =========================================================
  window.addEventListener('DOMContentLoaded', initDashboard);

  document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
  });

  document.getElementById('themeToggle').addEventListener('click', () => {
     const html = document.documentElement;
     html.setAttribute('data-theme', html.getAttribute('data-theme') === 'carbon' ? 'quartz' : 'carbon');
  });

  function switchView(view) {
      if(view === 'dashboard') document.getElementById('view-dashboard').style.display = 'grid';
  }
</script>

</body>
</html>
