<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G12 Labs â€“ Dashboard (Enzyme)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont;
      background: #0b0f14;
      color: #e6e8eb;
    }

    .container {
      max-width: 960px;
      margin: auto;
      padding: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .sub {
      opacity: 0.6;
      margin-bottom: 32px;
    }

    .card {
      background: #111827;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .value {
      font-size: 22px;
      font-weight: 600;
    }

    button {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      color: #001b0d;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      background: #1f2937;
      color: #e6e8eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Modal */
    #txModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .modal {
      background: #0f172a;
      padding: 24px;
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #020617;
      color: #fff;
      margin-bottom: 16px;
      box-sizing: border-box;
    }

    .loader {
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .footer {
      text-align: center;
      opacity: 0.4;
      font-size: 12px;
      margin-top: 40px;
    }

    .error {
      color: #ef4444;
      font-size: 13px;
      margin-top: 8px;
    }

    .success {
      color: #22c55e;
      font-size: 13px;
      margin-top: 8px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>G12 Labs</h1>
  <div class="sub">Real Enzyme Vault Dashboard</div>

  <div class="card">
    <div class="row">
      <div>Total Vault Supply</div>
      <div class="value" id="aumDisplay">â€”</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>Your Shares</div>
      <div class="value" id="userBalanceDisplay">â€”</div>
    </div>
    <div class="row">
      <div>Estimated Value</div>
      <div id="userValueDisplay">â€”</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button onclick="openModal('deposit')">Deposit</button>
      <button class="secondary" onclick="openModal('redeem')">Redeem</button>
    </div>
  </div>

  <div class="footer">
    G12 Labs Â· Enzyme Â· Arbitrum
  </div>
</div>

<!-- MODAL -->
<div id="txModal">
  <div class="modal">
    <h3 id="modalTitle">â€”</h3>
    <input id="txAmount" placeholder="Amount" type="number" step="any" />
    <div id="modalMessage"></div>
    <button id="confirmTxBtn">Confirm</button>
    <button class="secondary" style="margin-top:10px;width:100%" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
/* =========================================================
   CONFIG
   ========================================================= */

const VAULT_PROXY = "0x591E7194FEe6f5615EA89000318E630EaB92FBe1";
const RPC_URL = "https://arb1.arbitrum.io/rpc";

const VAULT_ABI = [
  "function getAccessor() view returns (address)",
  "function balanceOf(address) view returns (uint256)",
  "function totalSupply() view returns (uint256)"
];

const COMPTROLLER_ABI = [
  "function getDenominationAsset() view returns (address)",
  "function buyShares(uint256,uint256) returns (uint256)",
  "function redeemShares(uint256,uint256) returns (uint256)"
];

const ERC20_ABI = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256)",
  "function allowance(address,address) view returns (uint256)"
];

let rpcProvider, vault, comptroller, asset, assetDecimals, assetSymbol, user;

/* =========================================================
   INIT
   ========================================================= */

async function initDashboard() {
  try {
    rpcProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
    vault = new ethers.Contract(VAULT_PROXY, VAULT_ABI, rpcProvider);

    const comptrollerAddr = await vault.getAccessor();
    comptroller = new ethers.Contract(comptrollerAddr, COMPTROLLER_ABI, rpcProvider);

    const assetAddr = await comptroller.getDenominationAsset();
    asset = new ethers.Contract(assetAddr, ERC20_ABI, rpcProvider);

    assetDecimals = await asset.decimals();
    assetSymbol = await asset.symbol();

    if (window.ethereum) {
      const web3 = new ethers.providers.Web3Provider(window.ethereum);
      const accounts = await web3.listAccounts();
      if (accounts.length) {
        user = accounts[0];
        scanUser();
      }
    }

    scanVault();
  } catch (e) {
    console.error("Init failed:", e);
  }
}

async function scanVault() {
  try {
    const supply = await vault.totalSupply();
    document.getElementById("aumDisplay").innerText =
      parseFloat(ethers.utils.formatUnits(supply, 18)).toFixed(2) + " Shares";
  } catch (e) {
    console.error("Scan vault failed:", e);
  }
}

async function scanUser() {
  try {
    const bal = await vault.balanceOf(user);
    const shares = parseFloat(ethers.utils.formatUnits(bal, 18));
    document.getElementById("userBalanceDisplay").innerText = shares.toFixed(4) + " Shares";
    document.getElementById("userValueDisplay").innerText =
      "â‰ˆ " + shares.toFixed(2) + " " + assetSymbol;
  } catch (e) {
    console.error("Scan user failed:", e);
  }
}

/* =========================================================
   MODAL
   ========================================================= */

let currentAction = null;

function openModal(action) {
  currentAction = action;
  document.getElementById("modalTitle").innerText =
    action === "deposit" ? "Deposit " + assetSymbol : "Redeem Shares";
  document.getElementById("txModal").style.display = "flex";
  document.getElementById("txAmount").value = "";
  document.getElementById("modalMessage").innerHTML = "";
  document.getElementById("confirmTxBtn").onclick =
    action === "deposit" ? executeDeposit : executeRedeem;
}

function closeModal() {
  document.getElementById("txModal").style.display = "none";
  document.getElementById("txAmount").value = "";
  document.getElementById("modalMessage").innerHTML = "";
}

function showModalMessage(msg, isError = false) {
  const el = document.getElementById("modalMessage");
  el.innerHTML = `<div class="${isError ? 'error' : 'success'}">${msg}</div>`;
}

/* =========================================================
   DEPOSIT (FIXED)
   ========================================================= */

async function executeDeposit() {
  const amountInput = document.getElementById("txAmount").value;
  if (!amountInput || amountInput <= 0) {
    showModalMessage("Invalid amount", true);
    return;
  }

  const btn = document.getElementById("confirmTxBtn");
  const originalText = btn.innerText;
  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span> Connecting';

  try {
    const web3 = new ethers.providers.Web3Provider(window.ethereum);
    await web3.send("eth_requestAccounts", []);
    const signer = web3.getSigner();
    const me = await signer.getAddress();

    const assetTx = new ethers.Contract(asset.address, ERC20_ABI, signer);
    const comptrollerTx = new ethers.Contract(comptroller.address, COMPTROLLER_ABI, signer);

    const amount = ethers.utils.parseUnits(amountInput, assetDecimals);

    // Check balance
    btn.innerHTML = '<span class="loader"></span> Checking';
    const balance = await assetTx.balanceOf(me);
    if (balance.lt(amount)) {
      showModalMessage(`Insufficient ${assetSymbol} balance`, true);
      btn.disabled = false;
      btn.innerText = originalText;
      return;
    }

    // Check/approve
    const allowance = await assetTx.allowance(me, VAULT_PROXY);
    if (allowance.lt(amount)) {
      btn.innerHTML = '<span class="loader"></span> Approving';
      const txApprove = await assetTx.approve(VAULT_PROXY, ethers.constants.MaxUint256);
      await txApprove.wait();
    }

    // Calculate minShares (2.5% slippage protection)
    const minShares = amount.mul(975).div(1000);

    btn.innerHTML = '<span class="loader"></span> Depositing';
    const tx = await comptrollerTx.buyShares(amount, minShares, { gasLimit: 600000 });
    await tx.wait();

    closeModal();
    scanUser();
    scanVault();
    alert("Deposit successful ðŸš€\nTx: " + tx.hash);

  } catch (e) {
    console.error(e);
    showModalMessage(e.message || "Transaction failed", true);
  } finally {
    btn.disabled = false;
    btn.innerText = originalText;
  }
}

/* =========================================================
   REDEEM (FIXED)
   ========================================================= */

async function executeRedeem() {
  const amountInput = document.getElementById("txAmount").value;
  if (!amountInput || amountInput <= 0) {
    showModalMessage("Invalid amount", true);
    return;
  }

  const btn = document.getElementById("confirmTxBtn");
  const originalText = btn.innerText;
  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span> Connecting';

  try {
    const web3 = new ethers.providers.Web3Provider(window.ethereum);
    await web3.send("eth_requestAccounts", []);
    const signer = web3.getSigner();
    const me = await signer.getAddress();

    const comptrollerTx = new ethers.Contract(comptroller.address, COMPTROLLER_ABI, signer);
    const shares = ethers.utils.parseUnits(amountInput, 18);

    // Check balance
    btn.innerHTML = '<span class="loader"></span> Checking';
    const balance = await vault.balanceOf(me);
    if (balance.lt(shares)) {
      showModalMessage("Insufficient shares balance", true);
      btn.disabled = false;
      btn.innerText = originalText;
      return;
    }

    // Calculate minAssets (2.5% slippage protection)
    // Assuming 1 share â‰ˆ 1 asset (adjust if needed)
    const minAssets = shares.mul(975).div(1000);

    btn.innerHTML = '<span class="loader"></span> Redeeming';
    const tx = await comptrollerTx.redeemShares(shares, minAssets, { gasLimit: 600000 });
    await tx.wait();

    closeModal();
    scanUser();
    scanVault();
    alert("Redeem successful ðŸ’¸\nTx: " + tx.hash);

  } catch (e) {
    console.error(e);
    showModalMessage(e.message || "Transaction failed", true);
  } finally {
    btn.disabled = false;
    btn.innerText = originalText;
  }
}

window.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
